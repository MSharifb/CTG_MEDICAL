@model BEPZA_MEDICAL.Web.Areas.PRM.ViewModel.ApprovalFlow.ApprovalFlowDetailViewModel

<div style="position: relative;">
    <div class="form-group">
        @Html.LabelFor(m => m.StepName, new { @class = "col-sm-3 control-label labelRequired" })
        <div class="col-sm-6">
            @Html.TextBoxFor(m => m.StepName, new { style = "width:100%;" })
        </div>
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.ApprovalStepTypeId, new { @class = "col-sm-3 control-label labelRequired" })
        <div class="col-sm-6">
            @Html.DropDownListFor(m => m.ApprovalStepTypeId, Model.StepTypeList, @String.Format("{0}", Content.DDLOptionalLabel()), new { @class = "form-control" })
        </div>
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.StepSequence, new { @class = "col-sm-3 control-label labelRequired" })
        <div class="col-sm-6">
            @Html.DropDownListFor(m => m.StepSequence, Model.StepSequenceList, @String.Format("{0}", Content.DDLOptionalLabel()), new { @class = "form-control" })
        </div>
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.NotificationMessage, new { @class = "col-sm-3 control-label" })
        <div class="col-sm-6">
            @Html.TextAreaFor(m => m.NotificationMessage, new { style = "width:100%; height:50px;", placeholder = "Custom notification message" })
        </div>
    </div>

    <div class="msg-var-area">
        
    </div>
</div>
<div class="form-group">
    <div class="col-sm-9" style="text-align:right;">
        <button class="btn btn-sm btn-primary" type="button" id="btnAddNewStep">
            <i class="fa fa-plus-circle"></i>
            Add Step
        </button>
        @*<a href="@Url.Action("Create")" class="btn btn-sm btn-primary">  Add new</a>*@
    </div>
</div>

<div class="form-group">
    <div class="col-sm-10" style="text-align:right;">
        <table id="tblStepInfo" class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th class="step-name">From</th>
                    <th class="step-type">Step Type</th>
                    <th class="step-sequence">Forward To</th>
                    <th class="step-notificationMsg">Notification Message</th>
                    <th class="control-option">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.DetailList.Count > 0)
                {
                    foreach (var item in Model.DetailList)
                    {
                        @Html.Partial("_ApprovalFlowItem", @item)
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script type="text/javascript">

    $(document).ready(function () {
        setTimeout(SetRequired, 500);
    });

    $('#btnAddNewStep').click(function () {

        var stepName = $('#StepName').val();
        var stepTypeId = $('#ApprovalStepTypeId').val();
        var stepSequence = $('#StepSequence').val();
        var notificationMessage = $('#NotificationMessage').val();

        if (stepName == '' || stepTypeId == '' || stepSequence == '') {
            SetRequired();
            return;
        }

        var stepList = CheckIsApprovedStepAdded();
        if (stepList.length > 0) {
            alert("Approval Step already added.");
            return;
        }

        var url = '@Url.Action("AddNewStep", "ApprovalFlow")';

        $.ajax({
            url: url,
            type: 'POST',
            data: { stepName: stepName, stepTypeId: stepTypeId, stepSequence: stepSequence, notificationMessage: notificationMessage },
            cache: false,
            success: function (html) {
                $('#tblStepInfo tbody').append("<tr>" + html + "</tr>");
            }
        })
        setTimeout(SetSequenceDdlValue, 2000);
        $('#StepName').val('');
    });

    function CheckIsApprovedStepAdded() {
        var stepList = new Array();
        $('#tblStepInfo tbody .step-type').each(function () {
            var item = $(this).html();
            if (item == 'Approval') {
                stepList.push(item);
            }
        });
        return stepList;
    };

    function SetSequenceDdlValue() {
        var sequenceList = new Array();
        $('#tblStepInfo tbody .step-sequence').each(function () {
            var item = $(this).html();
            sequenceList.push(item);
        });

        $('#StepSequence').empty();
        $('#StepSequence').append($('<option></option>').val('Initial Step').html('Initial Step'));
        $.each(sequenceList, function () {
            if (this != '') {
                $('#StepSequence').append($('<option></option>').val(this).html(this));
            }
        });
        $("#StepSequence option:last").attr("selected", "selected");
        $('#StepSequence option:not(:selected)').attr('disabled', true);
    }

    function SetRequired() {
        var stepName = $('#StepName').val();
        var stepTypeId = $('#ApprovalStepTypeId').val();
        var stepSequence = $('#StepSequence').val();
        if (stepName == '') {
            //$("#StepName").attr('required', true);
            $("#StepName").focus();
            return;
        }
        if (stepTypeId == '') {
            $("#ApprovalStepTypeId").focus();
            return;
        }
        if (stepSequence == '') {
            $("#StepSequence").focus();
            return;
        }
    };

</script>


<style type="text/css">
    table thead {
        /*background: #2980b9;*/
        background: #34495e;
        color: #FFFFFF;
        font-family: Tahoma;
        font-weight: bold;
        cursor: default;
    }

        table thead th {
            text-align: center;
            padding: 6px 2px !important;
        }

    .step-name, .step-sequence {
        min-width: 200px;
        width: 200px;
    }

    .step-type {
        min-width: 150px;
        width: 150px;
    }

    .control-option {
        min-width: 50px;
        width: 50px;
    }


    table tbody tr td {
        text-align: left;
        padding: 5px !important;
        vertical-align: middle;
        font-family: Tahoma !important;
        font-size: 13px !important;
        word-wrap: break-word;
    }

    .delete-button {
        padding: 1px 5px !important;
    }
</style>